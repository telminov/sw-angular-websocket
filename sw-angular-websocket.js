(function() {
  var indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  angular.module('swWebSocket', []).constant('WS_STATUSES', ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED']).constant('WS_CLOSE_STATUSES', ['CLOSING', 'CLOSED']).constant('WS_OPEN_STATUS', 'OPEN').factory('swWebSocket', function($q, $interval, $timeout, WS_STATUSES, WS_CLOSE_STATUSES, WS_OPEN_STATUS) {
    var swWebSocket;
    swWebSocket = (function() {
      function swWebSocket(wsUri) {
        this.wsUri = wsUri;
        this.durable = false;
        this.messagesToSend = [];
        this.startHandlers = [];
        this.messageHandlers = [];
        this.errorHandlers = [];
        this._socket = void 0;
      }

      swWebSocket.prototype.start = function(durable) {
        this._getSocket();
        if (durable) {
          return this.durable = true;
        }
      };

      swWebSocket.prototype.close = function() {
        this.durable = false;
        return this._socket.close();
      };

      swWebSocket.prototype.send = function(msg) {
        this.messagesToSend.push(msg);
        return this._getSocket();
      };

      swWebSocket.prototype.onStart = function(callback) {
        return this.startHandlers.push(callback);
      };

      swWebSocket.prototype.onMessage = function(callback) {
        return this.messageHandlers.push(callback);
      };

      swWebSocket.prototype.onError = function(callback) {
        return this.errorHandlers.push(callback);
      };

      swWebSocket.prototype.getStatus = function() {
        var status;
        status = void 0;
        if (this._socketExists()) {
          status = WS_STATUSES[this._socket.readyState];
        }
        return status;
      };

      swWebSocket.prototype.isOpen = function() {
        return this.getStatus() === WS_OPEN_STATUS;
      };

      swWebSocket.prototype.isClosed = function() {
        var ref;
        return ref = this.getStatus(), indexOf.call(WS_CLOSE_STATUSES, ref) >= 0;
      };

      swWebSocket.prototype._getSocket = function() {
        if (!this._isSocketActive()) {
          this._socket = this._createSocket();
        }
        return this._socket;
      };

      swWebSocket.prototype._createSocket = function() {
        var socket;
        socket = new WebSocket(this.wsUri);
        socket.onopen = (function(_this) {
          return function(event) {
            return _this._onSocketOpen(event);
          };
        })(this);
        socket.onclose = (function(_this) {
          return function(event) {
            return _this._onSocketClose(event);
          };
        })(this);
        socket.onmessage = (function(_this) {
          return function(event) {
            return _this._onSocketMessage(event);
          };
        })(this);
        socket.onerror = (function(_this) {
          return function(event) {
            return _this._onSocketError(event);
          };
        })(this);
        return socket;
      };

      swWebSocket.prototype._onSocketOpen = function(event) {
        var handler, i, len, ref;
        ref = this.startHandlers;
        for (i = 0, len = ref.length; i < len; i++) {
          handler = ref[i];
          handler(event.data);
        }
        return this._startSend();
      };

      swWebSocket.prototype._onSocketMessage = function(event) {
        var handler, i, len, ref, results;
        ref = this.messageHandlers;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          handler = ref[i];
          results.push(handler(event.data));
        }
        return results;
      };

      swWebSocket.prototype._onSocketError = function(event) {
        var handler, i, len, ref, results;
        ref = this.errorHandlers;
        results = [];
        for (i = 0, len = ref.length; i < len; i++) {
          handler = ref[i];
          results.push(handler(event));
        }
        return results;
      };

      swWebSocket.prototype._onSocketClose = function() {
        var restartConnection;
        this._stopSend();
        if (this.durable) {
          restartConnection = (function(_this) {
            return function() {
              return _this._getSocket();
            };
          })(this);
          return $timeout(restartConnection, 2000);
        }
      };

      swWebSocket.prototype._startSend = function() {
        var sendMsg;
        sendMsg = (function(_this) {
          return function() {
            var msg, results;
            results = [];
            while (_this._messagesExists() && _this._isSocketActive()) {
              msg = _this.messagesToSend.shift();
              results.push(_this._getSocket().send(msg));
            }
            return results;
          };
        })(this);
        return this.stopSendPromise = $interval(sendMsg, 500);
      };

      swWebSocket.prototype._stopSend = function() {
        if (this.stopSendPromise !== void 0) {
          return $interval.cancel(this.stopSendPromise);
        }
      };

      swWebSocket.prototype._socketExists = function() {
        return this._socket !== void 0;
      };

      swWebSocket.prototype._isSocketActive = function() {
        return this._socketExists() && !this.isClosed();
      };

      swWebSocket.prototype._messagesExists = function() {
        return this.messagesToSend.length > 0;
      };

      return swWebSocket;

    })();
    return swWebSocket;
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN3LWFuZ3VsYXItd2Vic29ja2V0LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUFBLE1BQUEsbUpBQUE7O0FBQUEsRUFBQSxPQUFPLENBQUMsTUFBUixDQUFlLGFBQWYsRUFBOEIsRUFBOUIsQ0FFQSxDQUFDLFFBRkQsQ0FFVSxhQUZWLEVBRXlCLENBQUMsWUFBRCxFQUFlLE1BQWYsRUFBdUIsU0FBdkIsRUFBa0MsUUFBbEMsQ0FGekIsQ0FHQSxDQUFDLFFBSEQsQ0FHVSxtQkFIVixFQUcrQixDQUFDLFNBQUQsRUFBWSxRQUFaLENBSC9CLENBSUEsQ0FBQyxRQUpELENBSVUsZ0JBSlYsRUFJNEIsTUFKNUIsQ0FNQSxDQUFDLE9BTkQsQ0FNUyxhQU5ULEVBTXdCLFNBQUMsRUFBRCxFQUFLLFNBQUwsRUFBZ0IsUUFBaEIsRUFBMEIsV0FBMUIsRUFBdUMsaUJBQXZDLEVBQTBELGNBQTFELEdBQUE7QUFDcEIsUUFBQSxXQUFBO0FBQUEsSUFBTTtBQUNXLE1BQUEscUJBQUMsS0FBRCxHQUFBO0FBQ1QsUUFBQSxJQUFJLENBQUMsS0FBTCxHQUFhLEtBQWIsQ0FBQTtBQUFBLFFBR0EsSUFBSSxDQUFDLE9BQUwsR0FBZSxLQUhmLENBQUE7QUFBQSxRQU1BLElBQUksQ0FBQyxjQUFMLEdBQXNCLEVBTnRCLENBQUE7QUFBQSxRQVNBLElBQUksQ0FBQyxhQUFMLEdBQXFCLEVBVHJCLENBQUE7QUFBQSxRQVVBLElBQUksQ0FBQyxlQUFMLEdBQXVCLEVBVnZCLENBQUE7QUFBQSxRQVdBLElBQUksQ0FBQyxhQUFMLEdBQXFCLEVBWHJCLENBQUE7QUFBQSxRQWFBLElBQUksQ0FBQyxPQUFMLEdBQWUsTUFiZixDQURTO01BQUEsQ0FBYjs7QUFBQSw0QkFpQkEsS0FBQSxHQUFPLFNBQUMsT0FBRCxHQUFBO0FBQ0gsUUFBQSxJQUFJLENBQUMsVUFBTCxDQUFBLENBQUEsQ0FBQTtBQUVBLFFBQUEsSUFBRyxPQUFIO2lCQUNJLElBQUksQ0FBQyxPQUFMLEdB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LENBQUEsSUFBUSxDQUFDLFFBQUwsQ0FBQSxDQUFwQyxDQURhO01BQUEsQ0FySGpCLENBQUE7O0FBQUEsNEJBd0hBLGVBQUEsR0FBaUIsU0FBQSxHQUFBO0FBQ2IsZUFBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQXBCLEdBQTZCLENBQXBDLENBRGE7TUFBQSxDQXhIakIsQ0FBQTs7eUJBQUE7O1FBREosQ0FBQTtBQThIQSxXQUFPLFdBQVAsQ0EvSG9CO0VBQUEsQ0FOeEIsQ0FBQSxDQUFBO0FBQUEiLCJmaWxlIjoic3ctYW5ndWxhci13ZWJzb2NrZXQuanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJhbmd1bGFyLm1vZHVsZSgnc3dXZWJTb2NrZXQnLCBbXSlcblxuLmNvbnN0YW50KCdXU19TVEFUVVNFUycsIFsnQ09OTkVDVElORycsICdPUEVOJywgJ0NMT1NJTkcnLCAnQ0xPU0VEJ10pXG4uY29uc3RhbnQoJ1dTX0NMT1NFX1NUQVRVU0VTJywgWydDTE9TSU5HJywgJ0NMT1NFRCddKVxuLmNvbnN0YW50KCdXU19PUEVOX1NUQVRVUycsICdPUEVOJylcblxuLmZhY3RvcnkgJ3N3V2ViU29ja2V0JywgKCRxLCAkaW50ZXJ2YWwsICR0aW1lb3V0LCBXU19TVEFUVVNFUywgV1NfQ0xPU0VfU1RBVFVTRVMsIFdTX09QRU5fU1RBVFVTKSAtPlxuICAgIGNsYXNzIHN3V2ViU29ja2V0XG4gICAgICAgIGNvbnN0cnVjdG9yOiAod3NVcmkpIC0+XG4gICAgICAgICAgICB0aGlzLndzVXJpID0gd3NVcmlcblxuICAgICAgICAgICAgIyBrZWVwIGFsaXZlXG4gICAgICAgICAgICB0aGlzLmR1cmFibGUgPSBmYWxzZVxuXG4gICAgICAgICAgICAjIG1lc3NhZ2VzIHF1ZXVlXG4gICAgICAgICAgICB0aGlzLm1lc3NhZ2VzVG9TZW5kID0gW11cblxuICAgICAgICAgICAgIyBoYW5kbGVyc1xuICAgICAgICAgICAgdGhpcy5zdGFydEhhbmRsZXJzID0gW11cbiAgICAgICAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzID0gW11cbiAgICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IFtdXG5cbiAgICAgICAgICAgIHRoaXMuX3NvY2tldCA9IHVuZGVmaW5lZFxuXG5cbiAgICAgICAgc3RhcnQ6IChkdXJhYmxlKSAtPlxuICAgICAgICAgICAgdGhpcy5fZ2V0U29ja2V0KClcblxuICAgICAgICAgICAgaWYgZHVyYWJsZVxuICAgICAgICAgICAgICAgIHRoaXMuZHVyYWJsZSA9IHRydWVcblxuICAgICAgICBjbG9zZTogLT5cbiAgICAgICAgICAgIHRoaXMuZHVyYWJsZSA9IGZhbHNlXG4gICAgICAgICAgICB0aGlzLl9zb2NrZXQuY2xvc2UoKVxuXG5cbiAgICAgICAgc2VuZDogKG1zZykgLT5cbiAgICAgICAgICAgICMgYWRkIG1lc3NhZ2UgdG8gbWVzc2FnZXMgbGlzdFxuICAgICAgICAgICAgdGhpcy5tZXNzYWdlc1RvU2VuZC5wdXNoKG1zZylcblxuICAgICAgICAgICAgIyBpbml0IGNvbm5lY3Rpb24gaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgICB0aGlzLl9nZXRTb2NrZXQoKVxuXG5cbiAgICAgICAgb25TdGFydDogKGNhbGxiYWNrKSAtPlxuICAgICAgICAgICAgdGhpcy5zdGFydEhhbmRsZXJzLnB1c2ggY2FsbGJhY2tcblxuICAgICAgICBvbk1lc3NhZ2U6IChjYWxsYmFjaykgLT5cbiAgICAgICAgICAgIHRoaXMubWVzc2FnZUhhbmRsZXJzLnB1c2ggY2FsbGJhY2tcblxuICAgICAgICBvbkVycm9yOiAoY2FsbGJhY2spIC0+XG4gICAgICAgICAgICB0aGlzLmVycm9ySGFuZGxlcnMucHVzaCBjYWxsYmFja1xuXG5cbiAgICAgICAgZ2V0U3RhdHVzOiAtPlxuICAgICAgICAgICAgc3RhdHVzID0gdW5kZWZpbmVkXG4gICAgICAgICAgICBpZiB0aGlzLl9zb2NrZXRFeGlzdHMoKVxuICAgICAgICAgICAgICAgIHN0YXR1cyA9IFdTX1NUQVRVU0VTW3RoaXMuX3NvY2tldC5yZWFkeVN0YXRlXVxuICAgICAgICAgICAgcmV0dXJuIHN0YXR1c1xuXG4gICAgICAgIGlzT3BlbjogLT5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFN0YXR1cygpID09IFdTX09QRU5fU1RBVFVTXG5cbiAgICAgICAgaXNDbG9zZWQ6IC0+XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTdGF0dXMoKSBpbiBXU19DTE9TRV9TVEFUVVNFU1xuXG5cbiAgICAgICAgX2dldFNvY2tldDogLT5cbiAgICAgICAgICAgIGlmIG5vdCB0aGlzLl9pc1NvY2tldEFjdGl2ZSgpXG4gICAgICAgICAgICAgICAgdGhpcy5fc29ja2V0ID0gdGhpcy5fY3JlYXRlU29ja2V0KClcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvY2tldFxuXG4gICAgICAgIF9jcmVhdGVTb2NrZXQ6ICgpIC0+XG4gICAgICAgICAgICBzb2NrZXQgPSBuZXcgV2ViU29ja2V0KHRoaXMud3NVcmkpXG5cbiAgICAgICAgICAgIHNvY2tldC5vbm9wZW4gPSAoZXZlbnQpID0+IHRoaXMuX29uU29ja2V0T3BlbihldmVudClcbiAgICAgICAgICAgIHNvY2tldC5vbmNsb3NlID0gKGV2ZW50KSA9PiB0aGlzLl9vblNvY2tldENsb3NlKGV2ZW50KVxuICAgICAgICAgICAgc29ja2V0Lm9ubWVzc2FnZSA9IChldmVudCkgPT4gdGhpcy5fb25Tb2NrZXRNZXNzYWdlKGV2ZW50KVxuICAgICAgICAgICAgc29ja2V0Lm9uZXJyb3IgPSAoZXZlbnQpID0+IHRoaXMuX29uU29ja2V0RXJyb3IoZXZlbnQpXG5cbiAgICAgICAgICAgIHJldHVybiBzb2NrZXRcblxuXG4gICAgICAgIF9vblNvY2tldE9wZW46IChldmVudCkgLT5cbiAgICAgICAgICAgIGZvciBoYW5kbGVyIGluIHRoaXMuc3RhcnRIYW5kbGVyc1xuICAgICAgICAgICAgICAgIGhhbmRsZXIoZXZlbnQuZGF0YSlcbiAgICAgICAgICAgIHRoaXMuX3N0YXJ0U2VuZCgpXG5cbiAgICAgICAgX29uU29ja2V0TWVzc2FnZTogKGV2ZW50KSAtPlxuICAgICAgICAgICAgZm9yIGhhbmRsZXIgaW4gdGhpcy5tZXNzYWdlSGFuZGxlcnNcbiAgICAgICAgICAgICAgICBoYW5kbGVyKGV2ZW50LmRhdGEpXG5cbiAgICAgICAgX29uU29ja2V0RXJyb3I6IChldmVudCkgLT5cbiAgICAgICAgICAgIGZvciBoYW5kbGVyIGluIHRoaXMuZXJyb3JIYW5kbGVyc1xuICAgICAgICAgICAgICAgIGhhbmRsZXIoZXZlbnQpXG5cbiAgICAgICAgX29uU29ja2V0Q2xvc2U6IC0+XG4gICAgICAgICAgICB0aGlzLl9zdG9wU2VuZCgpXG5cbiAgICAgICAgICAgICMgdHJ5aW5nIHJlY29ubmVjdFxuICAgICAgICAgICAgaWYgdGhpcy5kdXJhYmxlXG4gICAgICAgICAgICAgICAgcmVzdGFydENvbm5lY3Rpb24gPSA9PlxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9nZXRTb2NrZXQoKVxuICAgICAgICAgICAgICAgICR0aW1lb3V0KHJlc3RhcnRDb25uZWN0aW9uLCAyMDAwKVxuXG5cbiAgICAgICAgX3N0YXJ0U2VuZDogLT5cbiAgICAgICAgICAgIHNlbmRNc2cgPSA9PlxuICAgICAgICAgICAgICAgIHdoaWxlIHRoaXMuX21lc3NhZ2VzRXhpc3RzKCkgYW5kIHRoaXMuX2lzU29ja2V0QWN0aXZlKClcbiAgICAgICAgICAgICAgICAgICAgbXNnID0gdGhpcy5tZXNzYWdlc1RvU2VuZC5zaGlmdCgpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2dldFNvY2tldCgpLnNlbmQobXNnKVxuXG4gICAgICAgICAgICAjIHBlcmlvZGljYWxseSB0cnkgc2VuZCBtZXNzYWdlcyBmcm9tIHF1ZXVlXG4gICAgICAgICAgICB0aGlzLnN0b3BTZW5kUHJvbWlzZSA9ICRpbnRlcnZhbChzZW5kTXNnLCA1MDApXG5cbiAgICAgICAgX3N0b3BTZW5kOiAtPlxuICAgICAgICAgICAgaWYgdGhpcy5zdG9wU2VuZFByb21pc2UgIT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJGludGVydmFsLmNhbmNlbCh0aGlzLnN0b3BTZW5kUHJvbWlzZSlcblxuXG5cbiAgICAgICAgX3NvY2tldEV4aXN0czogLT5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb2NrZXQgIT0gdW5kZWZpbmVkXG5cbiAgICAgICAgX2lzU29ja2V0QWN0aXZlOiAtPlxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvY2tldEV4aXN0cygpIGFuZCBub3QgdGhpcy5pc0Nsb3NlZCgpXG5cbiAgICAgICAgX21lc3NhZ2VzRXhpc3RzOiAtPlxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZXNUb1NlbmQubGVuZ3RoID4gMFxuXG5cblxuICAgIHJldHVybiBzd1dlYlNvY2tldCJdfQ==